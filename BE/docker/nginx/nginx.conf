worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # Định nghĩa upstream cho API
    upstream bookstore_api {
        least_conn;  # Cân bằng tải theo số kết nối ít nhất
        # Backend chạy bằng docker run với --name bookstore-backend và expose port 8080
        server bookstore-backend:8080;
        # Có thể thêm nhiều instance API để cân bằng tải
        # server bookstore-backend-2:8080;
        # server bookstore-backend-3:8080;
    }

    # Định nghĩa upstream cho MinIO API (port 9000)
    upstream minio_api {
        least_conn;
        server minio:9000;
    }

    # Định nghĩa upstream cho MinIO Console (port 9001)
    upstream minio_console {
        least_conn;
        server minio:9001;
    }

    # Cấu hình log
    access_log /var/log/nginx/access.log;
    error_log  /var/log/nginx/error.log;

    # Cấu hình buffer và timeout
    client_max_body_size        100M;
    client_body_buffer_size     128k;
    proxy_connect_timeout       90;
    proxy_send_timeout          90;
    proxy_read_timeout          90;
    proxy_buffers               32 4k;

    # Main server block
    server {
        listen 80;
        server_name localhost bookstore.local;

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # API endpoints - proxy tới BookStore API
        location /api/ {
            proxy_pass http://bookstore_api/api/;
            proxy_http_version 1.1;
            
            # Headers
            proxy_set_header Host               $host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto  $scheme;
            proxy_set_header X-Forwarded-Host   $host;
            proxy_set_header X-Forwarded-Port   $server_port;

            # WebSocket support
            proxy_set_header Upgrade            $http_upgrade;
            proxy_set_header Connection         "upgrade";

            # Timeout settings
            proxy_connect_timeout 60s;
            proxy_send_timeout    60s;
            proxy_read_timeout    60s;
        }

        # MinIO API - File storage (phải đặt trước /minio/)
        location /minio-api/ {
            rewrite ^/minio-api/(.*) /$1 break;
            proxy_pass http://minio_api;
            proxy_http_version 1.1;
            
            proxy_set_header Host               $http_host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto  $scheme;
            proxy_set_header X-Forwarded-Host   $host;

            # MinIO specific headers
            proxy_set_header X-Amz-Date         $http_x_amz_date;
            proxy_set_header Authorization      $http_authorization;

            # Tăng timeout cho upload/download file lớn
            proxy_connect_timeout 300s;
            proxy_send_timeout    300s;
            proxy_read_timeout    300s;

            # Disable buffering cho streaming
            proxy_buffering        off;
            proxy_request_buffering off;
        }

        # MinIO Console - Web UI và API calls từ console
        location /minio/ {
            # API calls từ console phải đi tới MinIO server (port 9000)
            location ~ ^/minio/api/ {
                proxy_pass http://minio_api;
                proxy_http_version 1.1;
                
                proxy_set_header Host               $http_host;
                proxy_set_header X-Real-IP          $remote_addr;
                proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto  $scheme;
                
                proxy_buffering          off;
                chunked_transfer_encoding off;
                
                # Rewrite /minio/api/* to /api/*
                rewrite ^/minio(/api/.*)$ $1 break;
            }
            
            # Console UI files
            proxy_pass http://minio_console/;
            proxy_http_version 1.1;
            
            proxy_set_header Host               $http_host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto  $scheme;
            proxy_set_header X-NginX-Proxy      true;

            # WebSocket support
            proxy_set_header Upgrade            $http_upgrade;
            proxy_set_header Connection         "upgrade";

            proxy_buffering          off;
            chunked_transfer_encoding off;
        }

        # Storage - Direct bucket access for images
        location /storage/ {
            # Remove /storage prefix and proxy to MinIO
            rewrite ^/storage/(.*)$ /$1 break;
            proxy_pass http://minio_api;
            proxy_http_version 1.1;
            
            # Important: Use exact Host header for MinIO
            proxy_set_header Host               $http_host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto  $scheme;

            # Timeout settings for large files
            proxy_connect_timeout 300s;
            proxy_send_timeout    300s;
            proxy_read_timeout    300s;

            # Disable buffering for streaming
            proxy_buffering        off;
            proxy_request_buffering off;
            
            # Hide XML metadata response
            proxy_hide_header x-amz-id-2;
            proxy_hide_header x-amz-request-id;
        }

        # Direct access to buckets (alternative - backup path)
        location ~ ^/(book-images|bookstore-images|ebook-files|user-avatars)/ {
            proxy_pass http://minio_api;
            proxy_http_version 1.1;
            
            proxy_set_header Host               $http_host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto  $scheme;

            proxy_buffering        off;
            proxy_request_buffering off;
        }

        # Swagger UI (nếu có)
        location /swagger/ {
            proxy_pass http://bookstore_api/swagger/;
            proxy_http_version 1.1;
            
            proxy_set_header Host               $host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto  $scheme;
        }

        # Root endpoint - redirect hoặc serve static page
        location / {
            return 200 '{"status":"ok","message":"BookStore API Gateway","endpoints":["/api/","/storage/","/minio/","/swagger/","/health"]}';
            add_header Content-Type application/json;
        }

        # Error pages
        error_page 502 503 504 /50x.html;
        location = /50x.html {
            return 502 '{"error":"Service temporarily unavailable"}';
            add_header Content-Type application/json;
        }
    }
}
