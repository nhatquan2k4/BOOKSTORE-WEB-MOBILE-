pipeline {
    agent any

    environment {
        // --- SERVER & SSH CONFIG ---
        SERVER_HOST  = 'NQ.local'
        REMOTE_USER  = 'jenkins'
        SSH_CRED_ID  = 'windows-ssh-creds'
        
        // --- REGISTRY CONFIG ---
        REGISTRY_ID  = 'docker-registry'
        REGISTRY_URL = 'NQ.local:5000'
        
        // --- IMAGE CONFIG ---
        IMAGE_NAME   = 'bookstore-backend'
        IMAGE_TAG    = "v${BUILD_NUMBER}"
        
        // --- PATH CONFIG ---
        COMPOSE_PATH = 'D:\\BOOKSTORE-WEB-MOBILE-\\BE\\docker'
        ENV_FILE     = 'D:\\BOOKSTORE-WEB-MOBILE-\\BE\\.env.jenkins'
        
        // --- LOAD ENVIRONMENT VARIABLES ---
        DB_SERVER           = credentials('db-server')
        DB_NAME             = credentials('db-name')
        DB_USER             = credentials('db-user')
        DB_PASSWORD         = credentials('db-password')
        MINIO_ENDPOINT      = credentials('minio-endpoint')
        MINIO_ACCESS_KEY    = credentials('minio-access-key')
        MINIO_SECRET_KEY    = credentials('minio-secret-key')
        ASPNETCORE_ENV      = credentials('aspnetcore-environment')
        APP_PORT            = credentials('app-port')
        CONTAINER_PORT      = credentials('container-port')
        NGINX_CONTAINER     = credentials('nginx-container')
        NETWORK_PATTERN     = credentials('network-pattern')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Docker Build') {
            steps {
                dir('BE') {
                    sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
                }
            }
        }

        stage('Push to Registry') {
            steps {
                withCredentials([usernamePassword(credentialsId: REGISTRY_ID, usernameVariable: 'REG_USER', passwordVariable: 'REG_PASS')]) {
                    sh """
                        docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                        echo "${REG_PASS}" | docker login ${REGISTRY_URL} -u "${REG_USER}" --password-stdin
                        docker push ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                    """
                }
            }
        }

        stage('Deploy to Windows via SSH') {
            steps {
                sshagent(credentials: [SSH_CRED_ID]) {
                    script {
                        echo "--- Bắt đầu Deploy sang ${SERVER_HOST} ---"
                        
                        // Lấy user/pass registry để login trên máy Windows
                        withCredentials([usernamePassword(credentialsId: REGISTRY_ID, usernameVariable: 'D_USER', passwordVariable: 'D_PASS')]) {
                            
                            // 1. Login Docker trên Windows
                            sh "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} \"echo ${D_PASS} | docker login ${REGISTRY_URL} -u ${D_USER} --password-stdin\""

                            // 2. Stop & Remove container cũ (Dùng try-catch PowerShell để không lỗi nếu chưa có container)
                            sh "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} \"try { docker stop ${IMAGE_NAME}; docker rm ${IMAGE_NAME} } catch {}; echo 'Cleaned old container'\""

                            // 3. Khởi động Infrastructure (DB, MinIO) bằng Docker Compose
                            sh "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} \"cd ${COMPOSE_PATH}; docker compose up -d\""

                            // 4. Pull Image mới nhất
                            sh "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} \"docker pull ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}\""

                            // 5. Tìm tên Network (PowerShell syntax)
                            def findNetworkCmd = "docker network ls --format '{{.Name}}' | Where-Object { \\\$_ -like '*${NETWORK_PATTERN}*' } | Select-Object -First 1"
                            def networkName = sh(script: "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} \"${findNetworkCmd}\"", returnStdout: true).trim()
                            
                            echo "Found Network: '${networkName}'"
                            if (networkName == "") {
                                error "Không tìm thấy Docker Network nào có tên chứa '${NETWORK_PATTERN}'. Hãy kiểm tra lại docker-compose!"
                            }

                            // 6. Build Connection String
                            def connectionString = "Server=${DB_SERVER};Database=${DB_NAME};User Id=${DB_USER};Password=${DB_PASSWORD};TrustServerCertificate=True"
                            
                            // 7. Chạy Container mới với biến môi trường
                            sh """ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} "docker run -d \
                                --name ${IMAGE_NAME} \
                                --network ${networkName} \
                                -e ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENV} \
                                -e 'ConnectionStrings__UsersDb=${connectionString}' \
                                -e MinIO__Endpoint=${MINIO_ENDPOINT} \
                                -e MinIO__AccessKey=${MINIO_ACCESS_KEY} \
                                -e MinIO__SecretKey=${MINIO_SECRET_KEY} \
                                -p ${APP_PORT}:${CONTAINER_PORT} \
                                ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}\""""
                            
                            // 8. Sleep và restart Nginx
                            sh "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} \"Start-Sleep -Seconds 5; docker restart ${NGINX_CONTAINER}; docker ps --filter name=${IMAGE_NAME}\""
                        }
                    }
                }
            }
        }
    }
    
    post {
        success { echo "Deploy Success!" }
        failure { echo "Deploy Failed!" }
    }
}