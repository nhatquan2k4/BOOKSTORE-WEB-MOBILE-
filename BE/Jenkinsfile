pipeline {
    agent any

    environment {
        SERVER_IP    = '192.168.0.102'
        REGISTRY_URL = '192.168.0.102:5000'
        IMAGE_NAME   = 'bookstore-backend'
        IMAGE_TAG    = "v${BUILD_NUMBER}"
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Docker Build') {
            steps {
                dir('BE') {
                    sh """
                        docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
                    """
                }
            }
        }

        stage('Push to Registry') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'docker-registry',
                        usernameVariable: 'REG_USER',
                        passwordVariable: 'REG_PASS'
                    )
                ]) {
                    sh """
                        docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                        echo "${REG_PASS}" | docker login ${REGISTRY_URL} -u "${REG_USER}" --password-stdin
                        docker push ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                    """
                }
            }
        }

        stage('Deploy to Windows via SSH') {
            steps {
                script {
                    sshagent(['ssh']) {
                        withCredentials([
                            usernamePassword(
                                credentialsId: 'docker-registry',
                                usernameVariable: 'REG_USER',
                                passwordVariable: 'REG_PASS'
                            )
                        ]) {
                            // Create PowerShell script
                            sh """
                                cat > deploy.ps1 << 'EOF'
Write-Host "=== Step 1: Stop and remove old backend container ==="
docker stop bookstore-backend 2>\$null
if (\$?) { Write-Host "Stopped old container" } else { Write-Host "No old container to stop" }
docker rm bookstore-backend 2>\$null
if (\$?) { Write-Host "Removed old container" } else { Write-Host "No old container to remove" }

Write-Host "=== Step 2: Start infrastructure services ==="
cd D:\\BOOKSTORE-WEB-MOBILE-\\BE\\docker
docker compose up -d
Write-Host "Docker compose completed"

Write-Host "=== Step 3: Login to registry ==="
echo '${REG_PASS}' | docker login ${REGISTRY_URL} -u ${REG_USER} --password-stdin
Write-Host "Registry login completed"

Write-Host "=== Step 4: Pull backend image ==="
docker pull ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
Write-Host "Image pull completed"

Write-Host "=== Step 5: Deploy backend container ==="
docker run -d --name bookstore-backend --network docker_bookstore-network -e ASPNETCORE_ENVIRONMENT=Development -p 3030:8080 ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
Write-Host "Container deployed"

Write-Host "=== Step 6: Wait for backend ==="
Start-Sleep -Seconds 10

Write-Host "=== Step 7: Restart nginx ==="
docker restart bookstore-nginx
Write-Host "Nginx restarted"

Write-Host "=== Step 8: Show containers ==="
docker ps --filter network=docker_bookstore-network

Write-Host "=== Deployment completed ==="
EOF

                                # Create temp directory and copy script to Windows server
                                ssh -o StrictHostKeyChecking=no jenkins_deploy@${SERVER_IP} "mkdir C:/Users/jenkins_deploy/temp 2>nul || echo 'Directory exists'"
                                scp -o StrictHostKeyChecking=no deploy.ps1 jenkins_deploy@${SERVER_IP}:C:/Users/jenkins_deploy/temp/deploy.ps1
                                
                                # Execute PowerShell script on Windows
                                ssh -o StrictHostKeyChecking=no jenkins_deploy@${SERVER_IP} "powershell -ExecutionPolicy Bypass -File C:/Users/jenkins_deploy/temp/deploy.ps1"
                            """
                        }
                    }
                }
            }
        }
    }

    post {
        success { echo "Deploy success" }
        failure { echo "Pipeline lỗi – xem console log." }
    }
}
