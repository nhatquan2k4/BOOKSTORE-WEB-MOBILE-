pipeline {
    agent any

    parameters {
        // Job CI: để mặc định false (chạy build + test + build image + push image)
        // Job CD: set true để chỉ chạy Deploy
        booleanParam(
            name: 'DEPLOY_ONLY',
            defaultValue: false,
            description: 'Nếu bật, chỉ chạy bước Deploy (CD)'
        )
    }

    environment {
        REGISTRY_URL = "localhost:5000"
        IMAGE_NAME   = "bookstore-backend"
        IMAGE_TAG    = "latest"
    }

    stages {
        // ===== CI: Checkout source code =====
        stage('Checkout') {
            when {
                expression { !params.DEPLOY_ONLY } // Không chạy ở job CD
            }
            steps {
                checkout scm
                script {
                    echo "Branch: ${env.BRANCH_NAME}, Job: ${env.JOB_NAME}"
                }
            }
        }

        // ===== CI: Build & Test (.NET) =====
        stage('Build & Test') {
            when {
                expression { !params.DEPLOY_ONLY }
            }
            steps {
                bat """
                cd BE
                dotnet restore
                dotnet test
                """
            }
        }

        // ===== CI: Docker Build =====
        stage('Docker Build') {
            when {
                expression { !params.DEPLOY_ONLY }
            }
            steps {
                bat """
                cd BE
                docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
                """
            }
        }

        // ===== CI: Push image lên registry (chỉ branch 22-11) =====
        stage('Push Image (branch 22-11 only)') {
            when {
                allOf {
                    expression { !params.DEPLOY_ONLY }  // chỉ chạy trong CI
                    branch '22-11'                      // chỉ cho nhánh 22-11
                }
            }
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'docker-registry',
                    usernameVariable: 'REG_USER',
                    passwordVariable: 'REG_PASS'
                )]) {
                    bat """
                    docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                    docker login ${REGISTRY_URL} -u "%REG_USER%" -p "%REG_PASS%"
                    docker push ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                    """
                }
            }
        }

        // ===== CD: Deploy (chỉ branch 22-11, chỉ khi DEPLOY_ONLY = true) =====
        stage('Deploy (CD - branch 22-11)') {
            when {
                allOf {
                    branch '22-11'
                    expression { params.DEPLOY_ONLY }
                }
            }
            steps {
                bat """
                echo Deploying ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG} on branch 22-11

                REM Start / update SQL + MinIO bằng docker compose
                docker compose -f BE/docker/docker-compose.yml up -d

                REM Dừng & xoá container backend cũ (nếu có)
                docker stop bookstore-backend || echo "No old container to stop"
                docker rm   bookstore-backend || echo "No old container to remove"

                REM Pull image mới
                docker pull ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}

                REM Chạy container backend mới
                docker run -d ^
                  --name bookstore-backend ^
                  --network docker_bookstore-network ^
                  -e ASPNETCORE_ENVIRONMENT=Development ^
                  -e ConnectionStrings__UsersDb="Server=bookstore-sqlserver,1433;Database=BookStore;User Id=bookstoreUser;Password=BookstorePass1@;MultipleActiveResultSets=true;TrustServerCertificate=True" ^
                  -e MinIO__Endpoint=bookstore-minio:9000 ^
                  -e MinIO__AccessKey=minioadmin ^
                  -e MinIO__SecretKey=minioadmin123 ^
                  -e MinIO__BucketName=bookstore-images ^
                  -e MinIO__UseSSL=false ^
                  -p 3030:8080 ^
                  ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                """
            }
        }
    }
}
