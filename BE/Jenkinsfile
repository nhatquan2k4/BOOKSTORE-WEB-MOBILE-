pipeline {
    agent any

    parameters {
        booleanParam(
            name: 'DEPLOY_ONLY',
            defaultValue: false,
            description: 'Nếu bật, chỉ chạy bước Deploy (CD)'
        )
    }

    environment {
        REGISTRY_URL = "localhost:5000"
        IMAGE_NAME   = "bookstore-backend"
        IMAGE_TAG    = "latest"
    }

    stages {
        
        stage('Checkout') {
            when {
                expression { !params.DEPLOY_ONLY }
            }
            steps {
                checkout scm
                script {
                    echo "Branch: ${env.BRANCH_NAME}, Job: ${env.JOB_NAME}"
                }
            }
        }

        stage('Build & Test') {
            when {
                expression { !params.DEPLOY_ONLY }
            }
            steps {
                bat """
                cd BE
                dotnet restore
                dotnet test
                """
            }
        }

        stage('Docker Build') {
            when {
                expression { !params.DEPLOY_ONLY }
            }
            steps {
                bat """
                cd BE
                docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
                """
            }
        }

        stage('Push Image') {
            when {
                expression { !params.DEPLOY_ONLY }
            }
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'docker-registry',
                    usernameVariable: 'REG_USER',
                    passwordVariable: 'REG_PASS'
                )]) {
                    bat """
                    docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                    docker login ${REGISTRY_URL} -u "%REG_USER%" -p "%REG_PASS%"
                    docker push ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                    """
                }
            }
        }

        stage('Deploy (CD)') {
            when {
                expression { params.DEPLOY_ONLY }
            }
            steps {
                bat """
                echo Deploying ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}

                docker compose -f BE/docker/docker-compose.yml up -d

                docker stop bookstore-backend || echo "No old container"
                docker rm   bookstore-backend || echo "No old container"

                docker pull ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}

                docker run -d ^
                  --name bookstore-backend ^
                  --network docker_bookstore-network ^
                  -e ASPNETCORE_ENVIRONMENT=Development ^
                  -e ConnectionStrings__UsersDb="Server=bookstore-sqlserver,1433;Database=BookStore;User Id=bookstoreUser;Password=BookstorePass1@;MultipleActiveResultSets=true;TrustServerCertificate=True" ^
                  -e MinIO__Endpoint=bookstore-minio:9000 ^
                  -e MinIO__AccessKey=minioadmin ^
                  -e MinIO__SecretKey=minioadmin123 ^
                  -e MinIO__BucketName=bookstore-images ^
                  -e MinIO__UseSSL=false ^
                  -p 3030:8080 ^
                  ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                """
            }
        }
    }
}
