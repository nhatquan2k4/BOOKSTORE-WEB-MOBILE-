pipeline {
    agent any

    environment {
        SERVER_IP    = '192.168.0.102'
        REGISTRY_URL = '192.168.0.102:5000'
        IMAGE_NAME   = 'bookstore-backend'
        IMAGE_TAG    = "v${BUILD_NUMBER}"
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Docker Build') {
            steps {
                dir('BE') {
                    sh """
                        docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
                    """
                }
            }
        }

        stage('Push to Registry') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'docker-registry',
                        usernameVariable: 'REG_USER',
                        passwordVariable: 'REG_PASS'
                    )
                ]) {
                    sh """
                        docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                        echo "${REG_PASS}" | docker login ${REGISTRY_URL} -u "${REG_USER}" --password-stdin
                        docker push ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                    """
                }
            }
        }

        stage('Deploy to Windows via SSH') {
            steps {
                script {
                    def remote = [:]
                    remote.name = 'windows-server'
                    remote.host = SERVER_IP
                    remote.allowAnyHosts = true

                    withCredentials([
                        sshUserPrivateKey(
                            credentialsId: 'ssh',
                            keyFileVariable: 'IDENTITY_FILE',
                            passphraseVariable: '',
                            usernameVariable: 'SSH_USER'
                        )
                    ]) {
                        remote.user         = SSH_USER
                        remote.identityFile = IDENTITY_FILE

                        sshCommand remote: remote, command: """
                            echo "=== Step 1: Stop and remove old backend container ==="
                            docker stop bookstore-backend 2>nul || echo "No backend container running"
                            docker rm bookstore-backend 2>nul || echo "No backend container to remove"

                            echo "=== Step 2: Start infrastructure services ==="
                            cd D:/BOOKSTORE-WEB-MOBILE-/BE/docker
                            docker compose up -d
                            echo "Docker compose completed"

                            echo "=== Step 3: Login to registry ==="
                            echo admin123 | docker login ${REGISTRY_URL} -u admin --password-stdin
                            echo "Registry login completed"

                            echo "=== Step 4: Pull backend image ==="
                            docker pull ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                            echo "Image pull completed"

                            echo "=== Step 5: Deploy backend container ==="
                            docker run -d --name bookstore-backend --network docker_bookstore-network -e ASPNETCORE_ENVIRONMENT=Development -p 3030:8080 ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                            echo "Container deployed"

                            echo "=== Step 6: Wait for backend to be ready ==="
                            timeout /t 10 /nobreak

                            echo "=== Step 7: Restart nginx ==="
                            docker restart bookstore-nginx
                            echo "Nginx restarted"

                            echo "=== Step 8: Show running containers ==="
                            docker ps --filter network=docker_bookstore-network --format "table {{.Names}}\t{{.Image}}\t{{.Status}}"
                            
                            echo "=== Deployment completed successfully ==="
                        """
                    }
                }
            }
        }
    }

    post {
        success { echo "Deploy success" }
        failure { echo "Pipeline lỗi – xem console log." }
    }
}
