pipeline {
    agent any

    environment {

        SERVER_HOST  = 'NQ.local'  // mDNS hostname, tự động resolve IP khi đổi WiFi
        
        REMOTE_USER  = 'jenkins' 
        
        SSH_CRED_ID  = 'windows-ssh-creds'
        
        REGISTRY_ID  = 'docker-registry'

        // --- CẤU HÌNH DOCKER ---
        REGISTRY_URL = 'NQ.local:5000'  // Dùng mDNS cho Registry
        IMAGE_NAME   = 'bookstore-backend'
        IMAGE_TAG    = "v${BUILD_NUMBER}"
        
        COMPOSE_PATH = 'D:\\BOOKSTORE-WEB-MOBILE-\\BE\\docker'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Docker Build') {
            steps {
                dir('BE') {
                    sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
                }
            }
        }

        stage('Push to Registry') {
            steps {
                withCredentials([usernamePassword(credentialsId: REGISTRY_ID, usernameVariable: 'REG_USER', passwordVariable: 'REG_PASS')]) {
                    sh """
                        docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                        echo "${REG_PASS}" | docker login ${REGISTRY_URL} -u "${REG_USER}" --password-stdin
                        docker push ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                    """
                }
            }
        }

        stage('Deploy to Windows via SSH') {
            steps {
                sshagent(credentials: [SSH_CRED_ID]) {
                    script {
                        echo "--- Bắt đầu Deploy sang ${SERVER_HOST} ---"
                        
                        // Lấy user/pass registry để login trên máy Windows
                        withCredentials([usernamePassword(credentialsId: REGISTRY_ID, usernameVariable: 'D_USER', passwordVariable: 'D_PASS')]) {
                            
                            // 1. Login Docker trên Windows
                            sh "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} \"echo ${D_PASS} | docker login ${REGISTRY_URL} -u ${D_USER} --password-stdin\""

                            // 2. Backup docker-compose.yml hiện tại
                            sh "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} \"cd ${COMPOSE_PATH}; Copy-Item docker-compose.yml docker-compose.yml.bak -Force\""

                            // 3. Update docker-compose.yml để sử dụng image từ registry thay vì build
                            def composeUpdateCmd = """
                                cd ${COMPOSE_PATH};
                                \\\$content = Get-Content docker-compose.yml -Raw;
                                \\\$content = \\\$content -replace 'build:[\\s\\S]*?dockerfile: Dockerfile', 'image: ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}';
                                \\\$content | Set-Content docker-compose.yml;
                                Write-Host 'Updated docker-compose.yml to use image: ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}';
                            """
                            sh "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} \"${composeUpdateCmd}\""

                            // 4. Pull image mới từ registry
                            sh "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} \"docker pull ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}\""

                            // 5. Restart backend service với image mới
                            sh "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} \"cd ${COMPOSE_PATH}; docker compose up -d bookstore-api\""

                            // 6. Kiểm tra trạng thái
                            sh "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} \"docker ps --filter name=bookstore-api\""
                        }
                    }
                }
            }
        }
    }
    
    post {
        success { echo "Deploy Success!" }
        failure { echo "Deploy Failed!" }
    }
}