pipeline {
    agent any

    environment {

        SERVER_HOST  = 'NQ.local'  // mDNS hostname, tự động resolve IP khi đổi WiFi
        
        REMOTE_USER  = 'jenkins' 
        
        SSH_CRED_ID  = 'windows-ssh-creds'
        
        REGISTRY_ID  = 'docker-registry'

        // --- CẤU HÌNH DOCKER ---
        REGISTRY_URL = 'NQ.local:5000'  // Dùng mDNS cho Registry
        IMAGE_NAME   = 'bookstore-backend'
        IMAGE_TAG    = "v${BUILD_NUMBER}"
        
        COMPOSE_PATH = 'D:\\BOOKSTORE-WEB-MOBILE-\\BE\\docker'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Docker Build') {
            steps {
                dir('BE') {
                    sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
                }
            }
        }

        stage('Push to Registry') {
            steps {
                withCredentials([usernamePassword(credentialsId: REGISTRY_ID, usernameVariable: 'REG_USER', passwordVariable: 'REG_PASS')]) {
                    sh """
                        docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                        echo "${REG_PASS}" | docker login ${REGISTRY_URL} -u "${REG_USER}" --password-stdin
                        docker push ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                    """
                }
            }
        }

        stage('Deploy to Windows via SSH') {
            steps {
                sshagent(credentials: [SSH_CRED_ID]) {
                    script {
                        echo "--- Bắt đầu Deploy sang ${SERVER_HOST} ---"
                        
                        // Lấy user/pass registry để login trên máy Windows
                        withCredentials([usernamePassword(credentialsId: REGISTRY_ID, usernameVariable: 'D_USER', passwordVariable: 'D_PASS')]) {
                            
                            // 1. Login Docker trên Windows
                            sh "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} \"echo ${D_PASS} | docker login ${REGISTRY_URL} -u ${D_USER} --password-stdin\""

                            // 2. Stop & Remove container cũ (Dùng try-catch PowerShell để không lỗi nếu chưa có container)
                            sh "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} \"try { docker stop ${IMAGE_NAME}; docker rm ${IMAGE_NAME} } catch {}; echo 'Cleaned old container'\""

                            // 3. Khởi động Infrastructure (DB, MinIO) bằng Docker Compose
                            sh "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} \"cd ${COMPOSE_PATH}; docker compose up -d\""

                            // 4. Pull Image mới nhất
                            sh "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} \"docker pull ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}\""

                            // 5. Tìm tên Network (PowerShell syntax)
                            def findNetworkCmd = "docker network ls --format '{{.Name}}' | Where-Object { \\\$_ -like '*bookstore*' } | Select-Object -First 1"
                            def networkName = sh(script: "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} \"${findNetworkCmd}\"", returnStdout: true).trim()
                            
                            echo "Found Network: '${networkName}'"
                            if (networkName == "") {
                                error "Không tìm thấy Docker Network nào có tên chứa 'bookstore'. Hãy kiểm tra lại docker-compose!"
                            }

                            // 6. Chạy Container mới
                            sh """ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} "docker run -d --name ${IMAGE_NAME} --network ${networkName} -e ASPNETCORE_ENVIRONMENT=Development -e 'ConnectionStrings__UsersDb=Server=bookstore-sqlserver;Database=BookStore;User Id=bookstoreUser;Password=BookstorePass1@;TrustServerCertificate=True' -e MinIO__Endpoint=minio:9000 -e MinIO__AccessKey=minioadmin -e MinIO__SecretKey=minioadmin123 -p 3030:8080 ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}\""""
                            
                            // 7. Sleep và restart Nginx
                            sh "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_HOST} \"Start-Sleep -Seconds 5; docker restart bookstore-nginx; docker ps --filter name=${IMAGE_NAME}\""
                        }
                    }
                }
            }
        }
    }
    
    post {
        success { echo "Deploy Success!" }
        failure { echo "Deploy Failed!" }
    }
}